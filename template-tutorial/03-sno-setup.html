<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3. Deploy Managed Cluster Setup :: GitOps Infrastructure Configuration Workshop</title>
    <link rel="canonical" href="http://localhost:3000/rhs-build-course/index.html/template-tutorial/03-sno-setup.html">
    <link rel="prev" href="02-hub-setup.html">
    <link rel="next" href="04-day2-config.html#daytwooperations">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="http://localhost:3000/rhs-build-course/index.html">GitOps Infrastructure Configuration Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="template-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Table of Contents</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#gettutorialsources">1.2 Get tutorial sources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-hub-setup.html">2. Deploy Argo Hub Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-hub-setup.html#laboverview">2.1 Lab overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-hub-setup.html#environment">2.2 Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-hub-setup.html#hubsetup">2.3 Argo Hub Setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-sno-setup.html">3. Deploy Managed Cluster Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#managedconfiguration">3.1. Managed Cluster Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#helmcharts">3.2. Helm Charts</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-day2-config.html#daytwooperations">4. Day 2 Operations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#identityproviders">4.1 Configure Identity Providers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#deployoperators">4.2 Deploy Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#monitoring">4.3 Configure Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#namespace">4.4 Namespace Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#vault">4.5 Vault Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#appset">4.6 Day 2 with ApplicationSet</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-day2-config.html#summary">4.7 Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Lab GitOps infra</a></li>
    <li><a href="03-sno-setup.html">3. Deploy Managed Cluster Setup</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/jtovarro/manual-workshop-infra/edit/master/documentation/modules/ROOT/pages/03-sno-setup.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">3. Deploy Managed Cluster Setup</h1>
<div class="sect1">
<h2 id="managedconfiguration"><a class="anchor" href="#managedconfiguration"></a>3.1 Managed Cluster Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Argo Hub</em> setup has been already performed, so you just need to be focus on managed your Single Node OpenShift.</p>
</div>
<div class="paragraph">
<p>LetÂ´s make some modifications in the code to start deploying <em>GitOps</em> in the managed cluster. Open the <em>workshop-gitops-content-deploy</em> folder and make sure all the changes are done in the correct branch <em>sno-&lt;name&gt;-setup</em>:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
What is <a href="https://www.redhat.com/en/topics/devops/what-is-gitops">GitOps</a>?
</td>
</tr>
</table>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
git checkout sno-&lt;name&gt;-setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>As every user is deploying its own bootstrap file, they must have an unique name and they should be deployed on your scoped project where your user has privileges.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Change <strong>cluster-definition/sno-&lt;name&gt;</strong> folder as your assigned cluster as this value will be used as a parameter for ApplicationSet.
</td>
</tr>
</table>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
E.g.: mv cluster-definition/sno-&lt;name&gt; cluster-definition/sno-1</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Always replace <em>&lt;name&gt;</em> and <em>&lt;domain&gt;</em> by your assigned cluster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Update from <em>cluster-definition/sno-&lt;name&gt;/cluster.json</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>&lt;name&gt; &#8594; Assigned cluster</strong></p>
</li>
<li>
<p><strong>&lt;domain&gt; &#8594; Assigned domain cluster</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
vi cluster-definition/sno-&lt;name&gt;/cluster.json</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">{
  "environment": "dev",
  "cloud": "aws",
  "project": "project-sno-&lt;name&gt;",
  "region": "eu-central-1",
  "cluster": {
    "name": "sno-&lt;name&gt;",
    "address": "https://api.sno-&lt;name&gt;.&lt;domain&gt;.opentlc.com:6443"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You must also update <em>global-config/bootstrap-a/managed-setup.yaml</em>. Note how this application deploys to a different namespace and argo instance compared to <em>hub-setup</em> application.</p>
</div>
<div class="paragraph">
<p>Update from <em>global-config/bootstrap-a/managed-setup.yaml</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>&lt;name&gt; &#8594; Assigned cluster</strong></p>
</li>
<li>
<p><strong>&lt;your_user&gt; &#8594; Your GitHub user account</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
vi global-config/bootstrap-a/managed-setup.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: managed-setup-a-&lt;name&gt;
  namespace: openshift-operators
spec:
  destination:
    namespace: openshift-operators
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: project-sno-&lt;name&gt;
  source:
    repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
    targetRevision: sno-&lt;name&gt;-setup
    path: cluster-addons/cluster-addons-as/
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The source path of this Application points to the ApplicationSet used.</p>
</div>
<div class="paragraph">
<p>ApplicationSet is a Custom Resource that can be used to genereate Applications to multiple clusters from multiple originis. ApplicationSet controller is installed alongside ArgoCD even though it must be explicitaly enabled.</p>
</div>
<div class="paragraph">
<p>ApplicationSet is a helpful approach for multi cluster management, and it supplements ArgoCD by adding additional features in support of <em>cluster-administrator-focused</em> scanerios. Some of those are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ability to use a single Kubernetes manifest to target multiple Kubernetes clusters with ArgoCD.</p>
</li>
<li>
<p>Ability to use a single Kubernetes manifest to deploy multiple applications from one or multiple Git repositories with ArgoCD.</p>
</li>
<li>
<p>Improved support for monorepos (multiple ArgoCD Application resources defined within a single Git repository).</p>
</li>
<li>
<p>Improves ability of individual cluster tenants to deploy applications using ArgoCD (without needing to involve privileged cluster admin in enabling the destination servers).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ApplicationSet uses generators to create Application with multiple origins and destinations using templating.</p>
</div>
<div class="paragraph">
<p>Generator used may vary depending on your use case, in this example
we are using <em>Git Files</em> generator so cluster definition values are used as parameters. In case we had <em>'N' cluster-definition</em> files, the ApplicationSet would generate <em>'N'</em> Applications automatically.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Find more about <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Generators/">Generators</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we are going to take a look at <em>cluster-addons/cluster-addons-as/</em> in this folder we can expect two AplicationSet:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/workshop-content-deploy-folders-1.png" alt="workshop content deploy folders 1">
</div>
<div class="title">Figure 1. Folder structure</div>
</div>
<div class="paragraph">
<p>The first ApplicationSet <em>cluster-addons/cluster-addons-as/gitops-setup-sno-as.yaml</em> deploys the <em>openshift-gitops</em> operator and an initial non default <em>cluster wide</em> instance for infrastructure operations.</p>
</div>
<div class="paragraph">
<p>Update from <em>cluster-addons/cluster-addons-as/gitops-setup-sno-as.yaml</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>&lt;name&gt; &#8594; Assigned cluster</strong></p>
</li>
<li>
<p><strong>&lt;your_user&gt; &#8594; Your GitHub user account</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
vi cluster-addons/cluster-addons-as/gitops-setup-sno-as.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: gitops-setup-sno-&lt;name&gt;
  namespace: openshift-operators
spec:
  generators:
  - git:
      repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
      revision: sno-&lt;name&gt;-setup
      files:
      - path: "cluster-definition/**/cluster.json"
  template:
    metadata:
      name: 'gitops-setup-{{cluster.name}}-a'
    spec:
      project: '{{project}}'
      source:
        repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
        targetRevision: sno-&lt;name&gt;-setup
        path: cluster-addons/charts/gitops-setup
      destination:
        server: '{{cluster.address}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second ApplicationSet <em>cluster-addons/cluster-addons-as/bootstrap-sno-as.yaml</em> deploys an Application in the <em>argocd-infra</em> instance on manged cluster, called <em>sno-setup</em>, with configuration like: <em>RBAC</em>, a second <em>argocd-apps</em> instance, namespaces and vault.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diagram-4.png" alt="diagram 4">
</div>
<div class="title">Figure 2. sno-setup Application</div>
</div>
<div class="paragraph">
<p>Update from <em>cluster-addons/cluster-addons-as/bootstrap-sno-as.yaml</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>&lt;name&gt; &#8594; Assigned cluster</strong></p>
</li>
<li>
<p><strong>&lt;your_user&gt; &#8594; Your GitHub user account</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
vi cluster-addons/cluster-addons-as/bootstrap-sno-as.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: bootstrap-sno-&lt;name&gt;
  namespace: openshift-operators
spec:
  generators:
  - git:
      repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
      revision: sno-&lt;name&gt;-setup
      files:
      - path: "cluster-definition/**/cluster.json"
  template:
    metadata:
      name: 'bootstrap-{{cluster.name}}-a'
    spec:
      project: '{{project}}'
      source:
        repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
        targetRevision: sno-&lt;name&gt;-setup
        path: cluster-addons/charts/bootstrap-app
      destination:
        server: '{{cluster.address}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then update <em>cluster-addons/charts/bootstrap-app/values.yaml</em> file with your assigned data too:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>&lt;name&gt; &#8594; Assigned cluster</strong></p>
</li>
<li>
<p><strong>&lt;your_user&gt; &#8594; Your GitHub user account</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
vi cluster-addons/charts/bootstrap-app/values.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">clusters:
  sno-&lt;name&gt;:
    applicationNamespace: openshift-gitops
    namespace: ''
    destination: 'https://kubernetes.default.svc'
    project: default
    code:
      repo: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
      path: cluster-addons/charts/bootstrap
      target: sno-&lt;name&gt;-setup</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally replace values in bootstrap <em>cluster-addons/charts/bootstrap/values.yaml</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>&lt;domain&gt; &#8594; Assigned domain cluster</strong></p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
vi cluster-addons/charts/bootstrap-app/values.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">...
vault:
  vault_addr: "http://vault-vault.apps.argo-hub.&lt;domain&gt;.opentlc.com"
  avp_type: vault
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This ApplicationSet deploys an Application on the recently deployed instance on managed cluster to deploy and manage a second instance for applications.</p>
</div>
<div class="paragraph">
<p>Then navigate under source path to take a look to the Helm charts used for deploying GitOps and setting up the initial configuration for managed clusters.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/workshop-content-deploy-folders-2.png" alt="workshop content deploy folders 2">
</div>
<div class="title">Figure 3. GitOps Helm Charts</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
ApplicationSet controller is not enabled by default and must be configured on ArgoCD instance.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="helmcharts"><a class="anchor" href="#helmcharts"></a>3.2 Helm Charts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <strong>Helm chart</strong> is a set of <em>YAML</em> manifests and templates that describes Kubernetes resources (Deployments, Secrets, <em>CRDs</em>, etc.) and defined configurations needed for the Kubernetes application.</p>
</div>
<div class="paragraph">
<p>In the <em>argocd</em> instance of <em>Argo Hub</em>, the first Helm chart is <strong><em>gitops-setup</em></strong>, which deploys <em>openshift-gitops</em> operator on managed clusters. This chart is intented to deploy any kind of operator, even though in this case we are only deploying <em>openshift-gitops</em> operator.</p>
</div>
<div class="paragraph">
<p>If you navigate to <em>cluster-addons/charts/gitops-setup/templates/operators/subscription.yaml</em> resource you will see there is a global value for applying <em>env</em> variables for <em>GitOps</em>.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
vi cluster-addons/charts/gitops-setup/templates/operators/subscription.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">{{- range $key, $val := $.Values.operators }}
{{- if $val.enabled }}
---
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: {{ $key }}
  namespace: {{ $val.namespace }}
  {{- if $.Values.argocd.enabled }}
  annotations:
    argocd.argoproj.io/sync-wave: "-4"
  {{- end }}
spec:
  channel: {{ $val.channel }}
  installPlanApproval: {{ $val.approval }}
  name: {{ $val.name }}
  source: redhat-operators
  sourceNamespace: openshift-marketplace
{{- if $.Values.operators.gitops.enabled }}
  config:
    env:
    - name: ARGOCD_CLUSTER_CONFIG_NAMESPACES
      value: openshift-gitops
    - name: DISABLE_DEFAULT_ARGOCD_INSTANCE
      value: "true"
{{- end }}
{{- end }}
{{- end }}</code></pre>
</div>
</div>
<div class="paragraph">
<p>These configuration values disable the default ArgoCD instance and enables a new instance to be <em>cluster wide</em>. This means this <em>Argo Application Controller ServiceAccount</em> will have permissions to work in all namespaces within the cluster.</p>
</div>
<div class="paragraph">
<p>By default any new instance created is namespace scoped, this means you will only be allowed to deploy within your namespace. If you want to deploy across all namespace
you need to change this configuration to make the instance <em>cluster wide</em>. Additionally your <em>Argo ServiceAccount</em> may not have privileges enough to work with cluster wide resources and you might need to assign a new <em>Role Binding</em> for it.</p>
</div>
<div class="paragraph">
<p>You can either create a custom <em>Role Binding</em> or labelling any managed namespace by Argo so it will create this <em>Role Binding</em> automatically only for that namespace.</p>
</div>
<div class="paragraph">
<p>After setting this global variable you can see a new <em>Cluster Role Binding</em> for this <em>ServiceAccount</em> and this configuration on <em>Argo Hub</em> console in <em>openshift-operators</em> namespace.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get clusterrolebinding openshift-gitops-openshift-gitops-argocd-application-controller -n openshift-operators</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible also to take a look in the <em>Argo Hub</em> web console (<a href="https://console-openshift-console.apps.argo-hub.&lt;domain&gt;.opentlc.com/" class="bare">https://console-openshift-console.apps.argo-hub.&lt;domain&gt;.opentlc.com/</a>):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-wide-role-binding.png" alt="cluster wide role binding">
</div>
<div class="title">Figure 4. Cluster Role Binding</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Take a look to:
<a href="https://developers.redhat.com/articles/2023/03/06/5-global-environment-variables-provided-openshift-gitops#5_environment_variables__overview">Global Env Vars</a>, <a href="https://docs.openshift.com/container-platform/4.10/cicd/gitops/setting-up-argocd-instance.html#gitops-deploy-resources-different-namespaces_setting-up-argocd-instance">How to label namespaces</a>
and <a href="https://docs.openshift.com/container-platform/4.12/cicd/gitops/configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations.html#gitops-additional-permissions-for-cluster-config_configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations">How to create a <em>Role Binding</em></a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the <em>openshift-gitops</em> operator is running, we need to deploy the ArgoCD instance. To make sure instance is deployed after the operator is running we use <em>Sync Waves</em> and <em>Custom Resources Healthcheck</em>.</p>
</div>
<div class="paragraph">
<p><strong><em>Sync Waves</em></strong> are defined on each resource as annotations, and they tell Argo the order in which resources should be applied once the previous resource is already in healthy status.</p>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">...
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "-5"
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can take a look in detail to the <a href="https://argo-cd.readthedocs.io/en/stable/user-guide/sync-waves/">Sync Waves</a> documentation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For some specific resources they need a <strong><em>Custom Healthcheck</em></strong>. Most of the objects only require existing to work but others like <em>subscriptions</em> may exists but not progress to a successful status so we need a <em>Custom Healthcheck</em> to make sure the next <em>Sync Wave</em> does not start till the operators are properly installed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can take a look in detail to the <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/health/">Custom Healthcheck</a> documentation.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A <strong><em>Resource Healthcheck</em></strong> is defined in the <em>argocd</em> instace of <em>Argo Hub</em>, which is also deployed using Helm charts in <em>hub-setup/charts/gitops-setup/argocd.yaml</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next chart to take a look is <em>cluster-addons/charts/bootstrap-app</em>. This chart deploys an Application on the managed cluster <em>argocd-infra</em> instance to apply <em>bootstrap</em> chart.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
cat cluster-addons/charts/bootstrap-app/templates/application.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">{{- range $key, $val := $.Values.clusters }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $key }}-bootstrap
  namespace: {{ $val.applicationNamespace }}
spec:
  destination:
    server: {{ $val.destination }}
    namespace: ''
  project: {{ $val.project }}
  source:
    helm:
      valueFiles:
        - values.yaml
    path: {{ $val.code.path }}
    repoURL: {{ $val.code.repo }}
    targetRevision: {{ $val.code.target }}
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
{{- end }}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then on <em>cluster-addons/charts/bootstrap</em> folder you can find resources for deploying the second <em>argocd-apps</em> instance in the managed cluster, <em>namespaces</em>, <em>vault</em> and <em>RBAC</em> configuration.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy/cluster-addons/charts/bootstrap/templates/</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/workshop-content-deploy-folders-3.png" alt="workshop content deploy folders 3">
</div>
<div class="title">Figure 5. Bootstrap resources</div>
</div>
<div class="paragraph">
<p>The <em>argocd-apps</em> instance definition in <em>cluster-addons/charts/bootstrap/templates/argocd/argocd.yaml</em> is slightly similar to <em>argocd-infra</em> but it has some special customization, letÂ´s take a look:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Take a look to the <strong><em>resourceCustomizations</em></strong> section to review the <em>Custom Healthcheck</em>.
</td>
</tr>
</table>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
cat cluster-addons/charts/bootstrap/templates/argocd/argocd.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">...
    dex:
      openShiftOAuth: true # 1
      resources:
        limits:
          cpu: 500m
          memory: 256Mi
        requests:
          cpu: 250m
          memory: 128Mi
    provider: dex
  resourceTrackingMethod: annotation+label # 2
  applicationSet: # 3
...
  rbac: # 4
    defaultPolicy: ''
    policy: |-
      g, {{ $.Values.argocd.group }}, role:admin
      p, role:operator, applications, get, */*, allow
      p, role:operator, applications, sync, */*, allow
      g, argo-admins, role:admin
      g, argo-readers, role:readonly
      g, argo-operators, role:operator
      g, argo-dev-operators, role:operator-dev
    scopes: '[groups]'
...
    sidecarContainers: # 5
      - command:
          - /var/run/argocd/argocd-cmp-server
        image: 'quay.io/argoproj/argocd:v2.4.8'
        name: avp-helm
        volumeMounts:
          - mountPath: /var/run/argocd
            name: var-files
          - mountPath: /home/argocd/cmp-server/plugins
            name: plugins
          - mountPath: /tmp
            name: tmp-dir
          - mountPath: /home/argocd/cmp-server/config
            name: cmp-plugin
          - mountPath: /usr/local/bin/argocd-vault-plugin
            name: custom-tools
            subPath: argocd-vault-plugin
    volumeMounts:
      - mountPath: /usr/local/bin/argocd-vault-plugin
        name: custom-tools
        subPath: argocd-vault-plugin
    volumes:
      - configMap:
          name: cmp-plugin
        name: cmp-plugin
      - emptyDir: {}
        name: custom-tools
      - emptyDir: {}
        name: tmp-dir
...
  configManagementPlugins: | # 6
    - name: argocd-vault-plugin
      generate:
        command: ["argocd-vault-plugin"]
        args: ["generate", "./"]
  resourceCustomizations: | # 7
    operators.coreos.com/Subscription:
      health.lua: |
        health_status = {}
        if obj.status ~= nil then
          if obj.status.conditions ~= nil then
            numDegraded = 0
            numPending = 0
            msg = ""
            for i, condition in pairs(obj.status.conditions) do
              msg = msg .. i .. ": " .. condition.type .. " | " .. condition.status .. "\n"
              if condition.type == "InstallPlanPending" and condition.status == "True" then
                numPending = numPending + 1
              elseif (condition.type == "InstallPlanMissing" and condition.reason ~= "ReferencedInstallPlanNotFound") then
                numDegraded = numDegraded + 1
              elseif (condition.type == "CatalogSourcesUnhealthy" or condition.type == "InstallPlanFailed" or condition.type == "ResolutionFailed") and condition.status == "True" then
                numDegraded = numDegraded + 1
              end
            end
            if numDegraded == 0 and numPending == 0 then
              health_status.status = "Healthy"
              health_status.message = msg
              return health_status
            elseif numPending &gt; 0 and numDegraded == 0 then
              health_status.status = "Progressing"
              health_status.message = "An install plan for a subscription is pending installation"
              return health_status
            else
              health_status.status = "Degraded"
              health_status.message = msg
              return health_status
            end
          end
        end
        health_status.status = "Progressing"
        health_status.message = "An install plan for a subscription is pending installation"
        return health_status</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1) Dex uses groups and users defined within Openshift by checking the Oauth server.</p>
</li>
<li>
<p>2) Overrides default tracking method by label to annotation+label.</p>
</li>
<li>
<p>3) Enable ApplicationSet controller.</p>
</li>
<li>
<p>4) Configure argo RBAC.</p>
</li>
<li>
<p>5) Configure vault plugin as a sidecar container.</p>
</li>
<li>
<p>6) Configure new plugin for vault.</p>
</li>
<li>
<p>7) Configure resource healthcheck for Subscription.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you may notice, this instance contains some parametes for configuring <em>Vault Plugin</em>, which we will discuss later, and <em>RBAC</em> model.</p>
</div>
<div class="paragraph">
<p><strong><em>RBAC</em></strong> is defined on <em>cluster-addons/charts/bootstrap/templates/rbac/</em> folder and includes the basic configuration for Argo <em>RBAC</em> and projects.</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy/cluster-addons/charts/bootstrap/templates/rbac/</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/workshop-content-deploy-folders-4.png" alt="workshop content deploy folders 4">
</div>
<div class="title">Figure 6. RBAC folder</div>
</div>
<div class="paragraph">
<p>The <strong><em>RBAC</em></strong> feature enables restriction of access to ArgoCD resources. ArgoCD does not have its own user management system and has only one <em>built-in</em> user called <em>admin</em>.
The <em>admin</em> user is a superuser and it has unrestricted access to the system. <em>RBAC</em> requires <em>SSO</em> configuration, or one or more local users setup. Once <em>SSO</em> or local users are configured, additional <em>RBAC</em> roles can be defined, and <em>SSO</em> groups or local users can then be mapped to roles.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Find more in <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/rbac/">RBAC</a> documentation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ArgoCD has two pre-defined roles but <em>RBAC</em> configuration allows defining roles and groups. See below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1) role:readonly - read-only access to all resources</p>
</li>
<li>
<p>2) role:admin - unrestricted access to all resources</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally to the defined roles, it is possible to create some specific roles to allow <em>argo-operators</em> and <em>argo-dev-operators</em> group members manage applications in ArgoCD. See the groups in <em>cluster-addons/charts/bootstrap/templates/values.yaml</em> values file:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
vi cluster-addons/charts/bootstrap/templates/values.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">groups:
 argo-admins:
   user: user01 #  Admin permissions in ALL projects and applications
 argo-readers:
   user: user02 # Read-only permissions in ALL projects and applications
 argo-operators:
   user: user03 # View and Sync permission in ALL projects and applications
 argo-dev-operators:
   user: user04 #  View and Sync permission in DEV project and its applications
 argo-integration:
   user: apimanager01 # User has no permissions to see anything in Argo CD but has permissions to create objects in the Openshift Clusters
 cluster-admins:
   user: admin # full admin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then if you navigate to <em>RBAC</em> folder you can see a <em>Group</em> and a <em>Role Binding</em> resource to give <em>cluster-admin</em> permissions on Argo to the admin user configured via <em>Htpasswd</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/workshop-content-deploy-folders-4.png" alt="workshop content deploy folders 4">
</div>
<div class="title">Figure 7. RBAC folder</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For <em>RBAC</em> we need to differentiate between global configuration on <em>argocd-apps</em> intance and projects <em>RBAC</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you navigate to rbac section on <em>argo-apps</em> instance, you will see some <em>RBAC</em> policies starting like <strong>g</strong>  and <strong>p</strong>:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
cat cluster-addons/charts/bootstrap/templates/argocd/argocd.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">...
  rbac:
    defaultPolicy: ''
    policy: |-
      g, {{ $.Values.argocd.group }}, role:admin
      p, role:operator, applications, get, */*, allow
      p, role:operator, applications, sync, */*, allow
      g, argo-admins, role:admin
      g, argo-readers, role:readonly
      g, argo-operators, role:operator
      g, argo-dev-operators, role:operator-dev
    scopes: '[groups]'
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Policies starting with <em>'g'</em> assign roles to OpenShift local groups (they can be both Argo roles and OpenShift roles) and their users. While policies starting with <em>'p'</em> define specific policies for projects, resources, applications and their operations.</p>
</div>
<div class="paragraph">
<p>The following sections collect the information around <em>ArgoCD Roles</em> and <em>ArgoCD permission</em> in the managed clusters. It is important to understand the functionality matrix and permission that the following sections try to implement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><em>argo-admins</em></strong>: group members have full permissions in ArgoCD to <em>admin</em>.</p>
</li>
<li>
<p><strong><em>argo-readers</em></strong>: group members have <em>read-only</em> permissions in ArgoCD to access all information.</p>
</li>
<li>
<p><strong><em>argo-operators</em></strong>: group members have permission to manage applications (<em>get</em> and <em>sync</em>) only in ArgoCD-</p>
</li>
<li>
<p><strong><em>argo-dev-operators</em></strong>: group members have permission to manage applications (<em>get</em> and <em>sync</em>) only in <em>ArgoCD dev project</em>.</p>
</li>
<li>
<p><strong><em>apimanager01</em></strong>: user has no permissions to see anything in ArgoCD but has permissions to create objects in the OpenShift console.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then on <strong><em>AppProject</em></strong> we can define restrictions like <em>source repo</em>, <em>destination servers</em> and <em>resource whitelist</em> allowed per project. Moreover you can define local roles for that <em>AppProject</em>.</p>
</div>
<div class="paragraph">
<p>Last but not least are <strong><em>Namespaces</em></strong>. <em>Namespaces</em> are created as part of the bootstrap process by the <em>argo-infra</em> instance in the <em>SNO</em> so the operator in charge of managing apps lifecycle does not
need to have <em>cluster-wide</em> privileges.</p>
</div>
<div class="paragraph">
<p>Do not forget to <strong>push your changes to your working branch!</strong>, then we are going to deploy the <em>manage-setup-a-&lt;name&gt;</em> Application in order to <em>bootstrap</em> the <em>SNO</em>:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Make sure you are in the <em>sno-&lt;name&gt;-setup</em> branch.
</td>
</tr>
</table>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
git add .
git commit -m "bootstrap application for SNO"
git push sno-&lt;name&gt;-setup</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now login to <em>argocd</em> instance in <em>Argo Hub</em> (<a href="https://argocd-server-openshift-operators.apps.argo-hub.&lt;domain&gt;.opentlc.com" class="bare">https://argocd-server-openshift-operators.apps.argo-hub.&lt;domain&gt;.opentlc.com</a>)</p>
</li>
<li>
<p>Click <strong><em>LOG IN VIA OPENSHIFT</em></strong>.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-login-1.png" alt="argo login 1">
</div>
<div class="title">Figure 8. Log in argocd console instance</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Hit <strong><em>my_htpasswd_provider</em></strong>.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/hub-login-1.png" alt="hub login 1">
</div>
<div class="title">Figure 9. OpenShift credentials for argocd instance</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Insert <em>user-&lt;name&gt;</em> and <em>&lt;pass&gt;</em> provided by instructor and click <strong><em>Log in</em></strong> button.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/hub-login-2.png" alt="hub login 2">
</div>
<div class="title">Figure 10. argocd instance log in</div>
</div>
<div class="paragraph">
<p>To create bootstrap application, once logged in, click on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><em>New app</em></strong> &#8594; <strong><em>Edit as Yaml</em></strong></p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<strong>Insert the following Application with the changes we previously pushed to the repository</strong>:
</td>
</tr>
</table>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd ~/workshop-gitops-content-deploy
cat global-config/bootstrap-a/managed-setup.yaml</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: managed-setup-a-&lt;name&gt;
  namespace: openshift-operators
spec:
  destination:
    namespace: openshift-operators
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: project-sno-&lt;name&gt;
  source:
    repoURL: <a href="https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git" class="bare">https://github.com/&lt;your_user&gt;/workshop-gitops-content-deploy.git</a>
    targetRevision: sno-&lt;name&gt;-setup
    path: cluster-addons/cluster-addons-as/
  syncPolicy:
    automated:
      prune: true
      selfHeal: true</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Then hit <strong><em>Save</em></strong> &#8594; <strong><em>Create</em></strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At this point you should see some Applications on <em>Syncing</em> status on your <em>argocd</em> instance console. You cannot see your colleagues deployments thanks to <em>RBAC</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/managed-setup.png" alt="managed setup">
</div>
<div class="title">Figure 11. SNO bootstrap</div>
</div>
<div class="paragraph">
<p>Deep dive on <strong><em>managed-setup-a-&lt;name&gt;</em></strong> Application to check all the resources created. Next go back to the initial view and see how the Applications rendered by ApplicationSet are created.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/managed-setup-a-name.png" alt="managed setup a name">
</div>
<div class="title">Figure 12. ApplicationSet view</div>
</div>
<div class="paragraph">
<p>Verify in <em>Argo Hub</em> console (E.g. <a href="https://console-openshift-console.apps.argo-hub.&lt;domain&gt;.opentlc.com/" class="bare">https://console-openshift-console.apps.argo-hub.&lt;domain&gt;.opentlc.com/</a>) using your user with view role.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><em>user-&lt;name&gt;</em></strong></p>
</li>
<li>
<p><strong><em>&lt;pass&gt;</em></strong> provided by instructor at the beginning of the workshop</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Navigate to <strong><em>argocd</em></strong> instance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><em>Installed Operators</em></strong> &#8594; <strong><em>OpenShift GitOps*</em> &#8594; *<em>ArgoCD</em></strong> &#8594; <strong><em>argocd</em></strong></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-instance-view-1.png" alt="argocd instance view 1">
</div>
<div class="title">Figure 13. argocd view</div>
</div>
<div class="paragraph">
<p>Take a look to global <em>RBAC</em> policies and then navigate to <strong><em>AppProject</em></strong>
to verify your local permissions.</p>
</div>
<div class="paragraph">
<p>If you try to deploy a new Application from the OpenShift <em>Argo Hub</em> console you will see you can not deploy to a different cluster destination than your <em>SNO</em>.</p>
</div>
<div class="paragraph">
<p>Check this in the <em>argocd</em> instance <strong><em>Settings</em></strong> section  (E.g. <a href="https://argocd-server-openshift-operators.apps.argo-hub.&lt;domain&gt;.opentlc.com/settings" class="bare">https://argocd-server-openshift-operators.apps.argo-hub.&lt;domain&gt;.opentlc.com/settings</a>)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/settings-section-argocd.png" alt="settings section argocd">
</div>
<div class="title">Figure 14. Settings section</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click <strong><em>Clusters</em></strong> to view your destination cluster:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/clusters-list.png" alt="clusters list">
</div>
<div class="title">Figure 15. argocd clusters</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click <strong><em>Projects</em></strong>, it happens the same with projects, you can only see yours:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/projects-list.png" alt="projects list">
</div>
<div class="title">Figure 16. argocd projects</div>
</div>
<div class="paragraph">
<p>Once this is completed login to you managed cluster, <em>SNO</em>, and verify:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Remember to use your &lt;name&gt; and &lt;domain&gt;.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the OpenShift <em>SNO</em> console (E.g. <a href="https://console-openshift-console.apps.sno-&lt;name&gt;.&lt;domain&gt;.opentlc.com" class="bare">https://console-openshift-console.apps.sno-&lt;name&gt;.&lt;domain&gt;.opentlc.com</a>)</p>
</li>
<li>
<p>Hit <strong><em>my_htpasswd_provider</em></strong>.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/hub-login-1.png" alt="hub login 1">
</div>
<div class="title">Figure 17. SNO log in</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Insert <em>admin</em> as user and <em>&lt;pass&gt;</em> provided by instructor and click <strong><em>Log in</em></strong> button.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/hub-login-2.png" alt="hub login 2">
</div>
<div class="title">Figure 18. Insert SNO crentials to log in</div>
</div>
<div class="paragraph">
<p>Verify that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1) <strong><em>OpenShift GitOps</em></strong> operator is installed.</p>
</li>
<li>
<p>2) <strong><em>argo-infra</em></strong> instance exists as <em>ArgoCD</em> object and is <em>cluster-wide</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now Log in <em>argocd-infra</em> instance using OpenShift credentials, with user <em>admin</em> and &lt;pass&gt; provided by intructor.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>3) Click <strong><em>Settings</em></strong> section  (E.g. <a href="https://argocd-infra-openshift-gitops.apps.sno-&lt;name&gt;.&lt;domain&gt;.opentlc.com/settings" class="bare">https://argocd-infra-openshift-gitops.apps.sno-&lt;name&gt;.&lt;domain&gt;.opentlc.com/settings</a>)</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/settings-section-argocd.png" alt="settings section argocd">
</div>
<div class="title">Figure 19. Settings section</div>
</div>
<div class="ulist">
<ul>
<li>
<p>4) Click <strong><em>Clusters</em></strong> to view your destination cluster, then click again in the destination cluster to view the <em>Namespace</em> configuration, you should see <em>'All namespaces'</em>:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cluster-wide.png" alt="cluster wide">
</div>
<div class="title">Figure 20. General overview argocd-infra instance</div>
</div>
<div class="ulist">
<ul>
<li>
<p>5) Follow the same steps to verify that <strong><em>argocd-apps</em></strong> instance exists and is NOT <em>cluster-wide</em>.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-apps-general-1.png" alt="argocd apps general 1">
</div>
<div class="title">Figure 21. General overview argocd-apps instance</div>
</div>
<div class="ulist">
<ul>
<li>
<p>6) Both <em>'Dev'</em> and <em>'Pro'</em> <em>App Project</em> exist on <em>argocd-apps</em> instance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Verify you can create apliations on <em>'Dev'</em> project for <em>argocd-apps</em> instance.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This app should be deployed as <strong>prerequisite</strong> of <strong><em>4.5 Vault Configuration subsection</em></strong>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click &#8594; <strong><em>New app</em></strong> &#8594; <strong><em>Edit as Yaml</em></strong></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<strong>Insert the following Application with the changing <em>&lt;name&gt;</em> and &lt;your_user&gt;</strong>:
</td>
</tr>
</table>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  namespace: openshift-operators
  name: sno-&lt;name&gt;-vault
spec:
  destination:
    namespace: vault-secrets
    server: 'https://kubernetes.default.svc'
  source:
    helm:
      parameters:
        - name: vault.enabled
          value: 'true'
    path: .
    repoURL: 'https://github.com/&lt;your_user&gt;/helm-infra-gitops-workshop.git'
    targetRevision: sno-&lt;name&gt;
  project: dev
  syncPolicy:
    automated:
      prune: false
      selfHeal: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then hit <strong><em>Save</em></strong> &#8594; <strong><em>Create</em></strong></p>
</div>
<div class="paragraph">
<p>First log in the <em>SNO</em>, replace <strong><em>&lt;name&gt;</em></strong>, <strong><em>&lt;pass&gt;</em></strong> and <strong><em>&lt;domain&gt;</em></strong>:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc login -u admin -p &lt;pass&gt; <a href="https://api.sno-&lt;name&gt;.&lt;domain&gt;.opentlc.com:6443" class="bare">https://api.sno-&lt;name&gt;.&lt;domain&gt;.opentlc.com:6443</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the Application is created it deploys an app called <em>vault</em> in namespace <em>vault-secrets</em> that will encode a password and store it in <em>Vault</em>. If you access the application route you will not be able to see the password in plain text:</p>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get route vault -n vault-secrets
curl vault-vault-secrets.apps.sno-&lt;name&gt;.&lt;domain&gt;.opentlc.com</code></pre>
</div>
</div>
<div class="listingblock lines_7 console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">The password value is: &lt;password | base64encode&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have an application successfully deployed in the <em>argocd-apps</em> instance, it is possible to check <em>RBAC</em> configuration, for example try:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Login in the <em>argocd-apps</em> instance as user user04 and &lt;pass&gt; (argo-dev-operators) with role <em>operator-dev</em> and verify you can <em>'get'</em> and <em>'sync'</em> apps on <em>'dev'</em> project.</p>
</li>
<li>
<p>Login the <em>argocd-apps</em> instance as user apimanager01 and &lt;pass&gt; (api-manager) and verify you do not have permissions to see apps on <em>'dev'</em> project.</p>
</li>
</ul>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-hub-setup.html">2. Deploy Argo Hub Setup</a></span>
  <span class="next"><a href="04-day2-config.html#daytwooperations">4. Day 2 Operations</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
